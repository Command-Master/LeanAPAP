\chapter{Almost-Periodicity}
\label{chap:ap}


\begin{lemma}[Marcinkiewicz-Zygmund inequality]
\label{mzi}
\lean{other_marcinkiewicz_zygmund'}
\leanok
Let $m\geq 1$. If $f:G\to\bbr$ is such that $\bbe_x f(x)=0$ and $\abs{f(x)}\leq 2$ for all $x$ then
\[\bbe_{x_1,\ldots,x_n} \abs{\sum_{i=1}^n f(x_i)}^{2m} \leq (4mn)^{m}.\]
\end{lemma}

\begin{proof}
\leanok
Let $S$ be the left-hand side. Since $0=\bbe_y f(y)$ we have, by the triangle inequality, and H\"{o}lder's inequality,
\[S=\bbe_{x_1,\ldots,x_n}\left\lvert \sum_i f(x_i) - \bbe_{y_i} f(y_i)\right\rvert^{2m} = \bbe_{x_1,\ldots,x_n} \left\lvert\bbe_{y_i}\brac{\sum_i f(x_i)-f(y_i)}\right\rvert^{2m}\leq \bbe_{x_1,\dots,y_n} \left\lvert \sum_i f(x_i)-f(y_i)\right\rvert^{2m}.\]
Changing the role of $x_i$ and $y_i$ makes no difference here, but multiplies the $i$ summand by $\{-1,+1\}$, and therefore for any $\epsilon_i\in\{-1,+1\}$,
\[ S \leq\bbe_{x_1,\ldots,y_n}\left\lvert \sum_i \epsilon_i(f(x_i)-f(y_i))\right\rvert^{2m}.\]
In particular, if we sample $\epsilon_i\in\{-1,+1\}$ uniformly at random, then
\[ S \leq\bbe_{\epsilon_i} \bbe_{x_1,\ldots,y_n}\left\lvert \sum_i \epsilon_i(f(x_i)-f(y_i))\right\rvert^{2m}.\]
We now change the order of expectation and consider the expectation over just $\epsilon_i$, viewing the $f(x_i)-f(y_i)=z_i$, say, as fixed quantities. For any $z_i$ we can expand $\bbe_{\epsilon_i} \lvert \sum_i \epsilon_iz_i\rvert^{2m}$ and then bound it from above, using the triangle inequality and $\abs{z_i}\leq 4$, by
\[4^{2m}\sum_{k_1+\cdots+k_n=2m}\binom{2m}{k_1,\ldots,k_n}\abs{\bbe\epsilon_1^{k_1}\cdots \epsilon_n^{k_n}}.\]
The inner expectation vanishes unless each $k_i$ is even, when it is trivially one. Therefore the above quantity is exactly
\[\sum_{l_1+\cdots+l_n=m}\binom{2m}{2l_1,\ldots,2l_n}\leq m^mn^m,\]
since for any $l_1+\cdots+l_n=m$,
\[\binom{2m}{2l_1,\ldots,2l_n}\leq m^m\binom{m}{l_1,\ldots,l_n}.\]
This can be seen, for example, by writing both sides out using factorials, yielding

\[\frac{(2m)!}{(2l_1)!\cdots (2l_n)!}\leq \frac{(2m)!}{2^mm!}\frac{m!}{l_1!\cdots l_n!}\leq m^m\frac{m!}{l_1!\cdots l_n!}.\]
\end{proof}


\begin{lemma}[Complex-valued Marcinkiewicz-Zygmund inequality]
\label{mzi_complex}
\leanok
\lean{complex_marcinkiewicz_zygmund}
Let $m\geq 1$. If $f:G\to\bbc$ is such that $\bbe_x f(x)=0$ and $\abs{f(x)}\leq 2$ for all $x$ then
\[\bbe_{x_1,\ldots,x_n} \abs{\sum_{i=1}^n f(x_i)}^{2m} \leq (16mn)^{m}.\]
\end{lemma}

\begin{proof}
\uses{mzi}
\leanok
Test.
\end{proof}


\begin{lemma}
\label{random_approx_expect}
\lean{lemma28}
\leanok
Let $\epsilon>0$ and $m\geq 1$. Let $A\subseteq G$ and $f:G\to \bbc$. If $k\geq 64m\epsilon^{-2}$ then the set
\[L=\{ \tup{a}\in A^k : \|\tfrac{1}{k}\sum_{i=1}^kf(x-a_i)-\mu_A\ast f\|_{2m}\leq \epsilon \| f\|_{2m}\}.\]
has size at least $\lvert A \rvert^k/2$.
\end{lemma}

\begin{proof}
\uses{mzi_complex}
\leanok
Note that if $a\in A$ is chosen uniformly at random then, for any fixed $x\in G$,
\[\bbe f(x-a_i)= \frac{1}{\abs{A}}\sum_{a\in A}f(x-a)=\frac{1}{\abs{A}}\ind{A}\ast f(x)=\mu_A\ast f(x).\]
Therefore, if we choose $a_1,\ldots,a_k\in A$ independently uniformly at random, for any fixed $x\in G$ and $1\leq i\leq k$,  the random variable $f(x-a_i)-f\ast \mu_A(x)$ has mean zero. By the Marcinkiewicz-Zygmund inequality Lemma~\ref{mzi}, therefore,
\begin{multline*}
\bbe\abs{ \frac{1}{k}\sum_i f(x-a_i)-f\ast \mu_A(x)}^{2m} \leq \\(16m/k)^mk^{-1} \bbe \sum_i \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}.
\end{multline*}
We now sum both sides over all $x\in G$. By the triangle inequality, for any fixed $1\leq i\leq k$ and $a_i\in A$,
\begin{align*}
\sum_{x\in G} \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}
&\leq 2^{2m-1}\sum_{x\in G}\abs{f(x-a_i)}^{2m}+\sum_{x\in G}\abs{f\ast \mu_A(x)}^{2m}\\
&\leq 2^{2m-1}\brac{\norm{f}_{2m}^{2m}+\norm{f\ast \mu_A}_{2m}^{2m}}.
\end{align*}
We note that $\norm{\mu_A}_1=\frac{1}{\abs{A}}\sum_{x\in A}\ind{A}(x)=\abs{A}/\abs{A}=1$, and hence by Young's inequality, $\norm{f\ast \mu_A}_{2m}\leq \norm{f}_{2m}$, and so
\[\sum_{x\in G} \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}\leq 2^{2m}\norm{f}_{2m}^{2m}.\]
It follows that
\[\bbe_{a_1,\ldots,a_k\in A}\norm{\frac{1}{k}\sum_i\tau_{a_i}f-f\ast \mu_A}_{2m}^{2m}\leq
(64m/k)^m\norm{f}_{2m}^{2m}.\]
In particular, if $k\geq 64\epsilon^{-2}m$ then the right-hand side is at most $(\frac{\epsilon}{2}\norm{f}_{2m})^{2m}$ as required.
\end{proof}


\begin{lemma}
\label{aps_in_translates}
\lean{just_the_triangle_inequality}
\leanok
Let $A\subseteq G$ and $f:G\to \bbc$. Let $\epsilon>0$ and $m\geq 1$ and $k\geq 1$. Let
\[L=\{ \tup{a}\in A^k : \|\tfrac{1}{k}\sum_{i=1}^kf(x-a_i)-\mu_A\ast f\|_{2m}\leq \epsilon \| f\|_{2m}\}.\]
If $t\in G$ is such that $\tup{a}\in L$ and $\tup{a}+(t,\ldots,t)\in L$ then
\[\| \tau_t(\mu_A\ast f)-\mu_A\ast f\|_{2m}\leq 2\epsilon \|f\|_{2m}.\]
\end{lemma}

\begin{proof}
\leanok
Test.
\end{proof}


\begin{lemma}
\label{lots_of_diagonals}
\lean{big_shifts}
\leanok
Let $A\subseteq G$ and $k\geq 1$ and $L\subseteq A^k$. Then there exists some $\tup{a}\in L$ such that
\[\#\{ t\in G : \tup{a}+(t,\ldots,t)\in L\}\geq \frac{\lvert L\rvert}{\lvert A+S\rvert^k}\lvert S\rvert.\]
\end{lemma}

\begin{proof}
\leanok
Test.
\end{proof}


\begin{theorem}[$L_p$ almost periodicity]
\label{lp_ap}
\lean{almost_periodicity}
\leanok
Let $\epsilon\in (0,1]$ and $m\geq 1$. Let $K\geq 2$ and $A,S\subseteq G$ with $\lvert A+S\rvert\leq K\lvert A\rvert$.
Let $f:G\to \bbc$. There exists $T\subseteq G$ such that
\[\lvert T\rvert \geq K^{-512m\epsilon^{-2}}\lvert S\rvert\]
such that for any $t\in T$ we have
\[\| \tau_t(\mu_A\ast f)-\mu_A\ast f\|_{2m}\leq \epsilon \| f\|_{2m}.\]
\end{theorem}

\begin{proof}
\uses{random_approx_expect, lots_of_diagonals, aps_in_translates}
\leanok
Test.
\end{proof}


\begin{theorem}[$L_\infty$ almost periodicity]
\label{linfty_ap}
Let $\epsilon\in (0,1]$ and $m\geq 1$. Let $K\geq 2$ and $A,S\subseteq G$ with $\lvert A+S\rvert\leq K\lvert A\rvert$.
Let $B,C\subseteq G$. Let $\eta=\min(1,\lvert C\rvert/\lvert B\rvert)$. There exists $T\subseteq G$ such that
\[\lvert T\rvert \geq K^{-4096\lceil \lo{\eta}\rceil\epsilon^{-2}}\lvert S\rvert\]
such that for any $t\in T$ we have
\[\| \tau_t(\mu_A\ast 1_B\ast \mu_C)-\mu_A\ast 1_B\ast \mu_C\|_{\infty}\leq \epsilon.\]
\end{theorem}

\begin{proof}
\uses{lp_ap} Let $T$ be as given in \ref{lp_ap}
with $f=1_B$ and $m=\lceil \lo{\eta}\rceil$ and $\epsilon=\epsilon/e$. (The size bound on $T$ follows since $e^2\leq 8$.) Fix $t\in T$ and let $F=\tau_t(\mu_A\ast 1_B)-\mu_A\ast 1_B$. We have, for any $x\in G$,
\[(\tau_t(\mu_A\ast 1_B\ast \mu_C)-\mu_A\ast 1_B\ast \mu_C)(x)=F\ast \mu_C(x)=\sum_y F(y)\mu_{C}(x-y)=\sum_yF(y)\mu_{x-C}(y).\]
By HÃ¶lder's inequality, this is (in absolute value), for any $m\geq 1$,
\[\norm{F}_{2m}\norm{\mu_{x-C}}_{1+\frac{1}{2m-1}}.\]
By the construction of $T$ the first factor is at most
$\frac{\epsilon}{e}\| 1_B\|_{2m}=\frac{\epsilon}{e}\lvert B\rvert^{1/2m}$.
We have by calculation
\[\norm{\mu_{x-C}}_{1+\frac{1}{2m-1}}=\lvert x-C\rvert^{-1/2m}=\lvert C\rvert^{-1/2m}.\]
Therefore we have shown that

\[\| \tau_t(\mu_A\ast 1_B\ast \mu_C)-\mu_A\ast 1_B\ast \mu_C\|_{\infty}\leq \frac{\epsilon}{e}(\lvert C\rvert/\lvert B\rvert)^{-1/2m}.\]
The claim now follows since, by choice of $m$,
\[(\lvert C\rvert/\lvert B\rvert)^{-1/2m}\leq e\]
(dividing into cases as to whether $\eta=1$ or not).
\end{proof}


\begin{theorem}
\label{linfty_ap_boosted}

Let $\epsilon\in (0,1]$ and $m\geq 1$ and $k\geq 1$. Let $K\geq 2$ and $A,S\subseteq G$ with $\lvert A+S\rvert\leq K\lvert A\rvert$.
Let $B,C\subseteq G$. Let $\eta=\min(1,\lvert C\rvert/\lvert B\rvert)$. There exists $T\subseteq G$ such that
\[\lvert T\rvert \geq K^{-4096\lceil \lo{\eta}\rceil k^2\epsilon^{-2}}\lvert S\rvert\]
such that
\[\| \mu_T^{(k)}\ast \mu_A\ast 1_B\ast \mu_C-\mu_A\ast 1_B\ast \mu_C\|_{\infty}\leq \epsilon.\]
\end{theorem}

\begin{proof}
\uses{linfty_ap}
Let $T$ be as in Theorem~\ref{linfty_ap} with $\epsilon$ replaced by $\epsilon/k$. Note that, for any $x\in G$,
\[\mu_T^{(k)}\ast \mu_A\ast 1_B\ast \mu_C(x)=\frac{1}{\lvert T\rvert^k}\sum_{t_1,\ldots,t_k\in T}\tau_{t_1+\cdots+t_k}\mu_A\ast 1_B\ast \mu_C(x).\]
It therefore suffices (by the triangle inequality) to show, for any fixed $x\in G$ and $t_1,\ldots,t_k\in T$, that with $F=\mu_A\ast 1_B\ast \mu_C$, we have
\[\lvert \tau_{t_1+\cdots+t_k}F(x)-F(x)\rvert \leq \epsilon.\]
This follows by the triangle inequality applied $k$ times if we knew that, for $1\leq l\leq k$,
\[\lvert \tau_{t_1+\cdots+t_l}F(x)-\tau_{t_1+\cdots+t_{l-1}}F(x)\rvert \leq \epsilon/k.\]
We can write the left-hand side as
\[\lvert \tau_{t_1+\cdots+t_l}F(x)-\tau_{t_1+\cdots+t_{l-1}}F(x)\rvert=\lvert \tau_{t_l}F(x-t_1-\cdots-t-{l-1})-F(x-t_1-\cdots-t-{l-1})\rvert.\]
The right-hand side is at most
\[\| \tau_{t_l}F-F\|_\infty\]
and we are done by choice of $T$.
\end{proof}


\begin{theorem}\label{ap_in_ff}
If $A_1,A_2,S\subseteq \bbf_q^n$ are such that $A_1$ and $A_2$ both have density at least $\alpha$ then there is a subspace $V$ of codimension

\[\mathrm{codim}(V)\leq 2^{27}\lo{\alpha}^2\lo{\epsilon \alpha}^2\epsilon^{-2}\]
such that
\[\abs{\langle \mu_V\ast \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle-\langle \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle}\leq \epsilon.\]
\end{theorem}

\begin{proof}
\uses{chang, linfty_ap_boosted}
Let $k\geq 1$ be chosen later. Note that $\lvert A_1+G\rvert=\lvert G\rvert\leq \alpha^{-1}\lvert A\rvert$. Furthermore, $\lvert A_2\rvert/\lvert S\rvert\geq \alpha$. Therefore by Theorem~\ref{linfty_ap_boosted} there exists some $T\subseteq G$ with
\[\lvert T\rvert \geq \exp(-2^{16}\lo{\alpha}^2k^2\epsilon^{-2})\lvert S\rvert\]
such that
\[\| \mu_T^{(k)}\ast \mu_{A_1}\ast \mu_{A_2}\circ \ind{S}-\mu_{A_1}\ast \mu_{A_2}\circ \ind{S}\|_{\infty}\leq \epsilon/2.\]
Let $\Delta=\Delta_{1/2}(\mu_T)$ and
\[V = \{ x \in G : \gamma(x)=1\textrm{ for all }\gamma\in\Delta\}.\]
To show

\[\abs{\langle \mu_V\ast \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle-\langle \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle}\leq \epsilon\]
by the triangle inequality it suffices to show that, for any $v\in V$, 
\[\abs{\mu_{A_1}\ast \mu_{A_2}\circ \ind{S}(v)-\mu_{A_1}\ast \mu_{A_2}\circ \ind{S}(0)}\leq \epsilon.\]
By the triangle inequality and construction of $T$, it suffices to show that

\[\abs{\mu_T^{(k)}\ast \mu_{A_1}\ast \mu_{A_2}\circ \ind{S}(v)-\mu_T^{(k)}\ast\mu_{A_1}\ast \mu_{A_2}\circ \ind{S}(0)}\leq \epsilon/2.\]
By the Fourier transform we have, for any $x\in G$,
\[\mu_T^{(k)}\ast \mu_{A_1}\ast \mu_{A_2}\circ \ind{S}(x)=\frac{1}{N}\sum_{\gamma\in \widehat{G}}\widehat{\mu_T}(\gamma)^k\widehat{\mu_{A_1}}(\gamma)\widehat{\mu_{A_2}}(\gamma)\widehat{\ind{-S}}(\gamma)\gamma(x).\]
Therefore the left-hand side of the desired inequality is, by the triangle inequality, at most
\[\frac{1}{N}\sum_{\gamma\in \widehat{G}}\abs{\widehat{\mu_T}(\gamma)}^k\abs{\widehat{\mu_{A_1}}(\gamma)\widehat{\mu_{A_2}}(\gamma)\widehat{\ind{-S}}(\gamma)}\abs{\gamma(v)-1}.\]
By choice of $v\in V$ the summand vanishes when $\gamma\in\Delta$. When $\gamma\not\in \Delta$ the summand is bounded above by 
\[2^{1-k}\abs{\widehat{\mu_{A_1}}(\gamma)\widehat{\mu_{A_2}}(\gamma)\widehat{\ind{-S}}(\gamma)}.\]
Therefore the left-hand side of the desired inequality is at most
\[2^{1-k}\frac{1}{N}\sum_{\gamma}\abs{\widehat{\mu_{A_1}}(\gamma)\widehat{\mu_{A_2}}(\gamma)\widehat{\ind{-S}}(\gamma)}\leq 2^{1-k}\abs{S}\frac{1}{N}\sum_{\gamma}\abs{\widehat{\mu_{A_1}}(\gamma)\widehat{\mu_{A_2}}(\gamma)}\]
using the trivial bound $\lvert\widehat{\ind{S}}\rvert\leq \abs{S}$. By the Cauchy-Schwarz inequality the sum on the right is at most
\[\brac{\sum_\gamma \abs{\widehat{\mu_{A_1}}}^2}^{1/2}\brac{\sum_\gamma \abs{\widehat{\mu_{A_2}}}^2}^{1/2}.\]
By Parseval's identity this is at most $\alpha^{-1}$. Therefore the desired inequality follows from
\[2^{1-k}\abs{S}\frac{1}{N}\alpha^{-1}\leq 2^{1-k}\alpha^{-1}\leq \epsilon/2\]
if we choose $k=\lceil \lo{\epsilon\alpha/4}\rceil$.

It remains to check the codimension of $V$. For this, let $\Delta'\subseteq \Delta$ be as provided by Chang's lemma, Lemma~\ref{chang}, so that

\[\Delta\subseteq \left\{ \sum_{\gamma\in\Delta'}c_\gamma \gamma : c_\gamma\in \{-1,0,1\} \right\}.\]
Let 

\[W= \{ x \in G : \gamma(x)=1\textrm{ for all }\gamma\in\Delta'\}.\]
It follows that $W\leq V$, so it suffices to bound the codimension of $W$. This we can bound trivially using the bound from Chang's lemma and the fact that $\lo{\delta}=\log(e^2/\delta)\leq 2+\log(1/\delta)\leq 4\log(1/\delta)$, provided $\log(1/\delta)\geq 1$, so 
\[\abs{\Delta'}\leq  \lceil 4e\mathcal{L}(\delta)\rceil\leq 2^7\log(1\delta),\]
where
\[\delta=\abs{T}/N\geq \exp(-2^{16}\lo{\alpha}^2k^2\epsilon^{-2}),\]
so
\[\mathrm{codim}(V)\leq \abs{\Delta'}\leq 2^{23}\lo{\alpha}^2k^2\epsilon^{-2}\leq 2^{25}\lo{\alpha}^2\lo{\epsilon \alpha/4}^2\epsilon^{-2},\]
and now use $\lo{\epsilon\alpha/4}\leq 2\lo{\epsilon\alpha}$, say.
\end{proof}

