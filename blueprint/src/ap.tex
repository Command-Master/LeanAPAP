\chapter{Almost-Periodicity}
\label{chap:ap}


\begin{lemma}[Marcinkiewicz-Zygmund inequality]\label{mzi}
%\leanok
Let $m\geq 1$. If $f:G\to\bbr$ is such that $\bbe_x f(x)=0$ and $\abs{f(x)}\leq 2$ for all $x$ then
\[\bbe_{x_1,\ldots,x_n} \abs{\sum_{i=1}^n f(x_i)}^{2m} \leq (8mn)^{m}.\]
\end{lemma}
\begin{proof}
%\leanok
Let $S$ be the left-hand side. Since $0=\bbe_y f(y)$ we have, by the triangle inequality, and H\"{o}lder's inequality,
\[S=\bbe_{x_1,\ldots,x_n}\left\lvert \sum_i f(x_i) - \bbe_{y_i} f(y_i)\right\rvert^{2m} = \bbe_{x_1,\ldots,x_n} \left\lvert\bbe_{y_i}\brac{\sum_i f(x_i)-f(y_i)}\right\rvert^{2m}\leq \bbe_{x_1,\dots,y_n} \left\lvert \sum_i f(x_i)-f(y_i)\right\rvert^{2m}.\]
Changing the role of $x_i$ and $y_i$ makes no difference here, but multiplies the $i$ summand by $\{-1,+1\}$, and therefore for any $\epsilon_i\in\{-1,+1\}$, 
\[ S \leq\bbe_{x_1,\ldots,y_n}\left\lvert \sum_i \epsilon_i(f(x_i)-f(y_i))\right\rvert^{2m}.\]
In particular, if we sample $\epsilon_i\in\{-1,+1\}$ uniformly at random, then 
\[ S \leq\bbe_{\epsilon_i} \bbe_{x_1,\ldots,y_n}\left\lvert \sum_i \epsilon_i(f(x_i)-f(y_i))\right\rvert^{2m}.\]
We now change the order of expectation and consider the expectation over just $\epsilon_i$, viewing the $f(x_i)-f(y_i)=z_i$, say, as fixed quantities. For any $z_i$ we can expand $\bbe_{\epsilon_i} \lvert \sum_i \epsilon_iz_i\rvert^{2m}$ and then bound it from above, using the triangle inequality and $\abs{z_i}\leq 4$, by 
\[4^{2m}\sum_{k_1+\cdots+k_n=2m}\binom{2m}{k_1,\ldots,k_n}\abs{\bbe\epsilon_1^{k_1}\cdots \epsilon_n^{k_n}}.\]
The inner expectation vanishes unless each $k_i$ is even, when it is trivially one. Therefore the above quantity is exactly
\[\sum_{l_1+\cdots+l_n=m}\binom{2m}{2l_1,\ldots,2l_n}\leq m^mn^m,\]
since for any $l_1+\cdots+l_n=m$,
\[\binom{2m}{2l_1,\ldots,2l_n}\leq m^m\binom{m}{l_1,\ldots,l_n}.\]
This can be seen, for example, by writing both sides out using factorials, yielding

\[\frac{(2m)!}{(2l_1)!\cdots (2l_n)!}\leq \frac{(2m)!}{2^mm!}\frac{m!}{l_1!\cdots l_n!}\leq m^m\frac{m!}{l_1!\cdots l_n!}.\]
\end{proof}


\begin{lemma}\label{random_approx_expect}
Let $\epsilon>0$ and $m\geq 1$. Let $A\subseteq G$ and $f:G\to \{0,1\}$. If $k\geq 256m\epsilon^{-2}$ then the set

\[ \bbe_{a_1,\ldots,a_k\in A} \norm{ \mu_\tup{a}*f - \mu_A*f }_{2m}^{2m} \leq (\epsilon/2)^{2m}.\] 
\end{lemma}
\begin{proof}\uses{mzi}


Note that if $a\in A$ is chosen uniformly at random then, for any fixed $x\in G$,
\[\bbe f(x-a_i)= \frac{1}{\abs{A}}\sum_{a\in A}f(x-a)=\frac{1}{\abs{A}}\ind{A}\ast f(x)=\mu_A\ast f(x).\]
Therefore, if we choose $a_1,\ldots,a_k\in A$ independently uniformly at random, for any fixed $x\in G$ and $1\leq i\leq k$,  the random variable $f(x-a_i)-f\ast \mu_A(x)$ has mean zero. By the Marcinkiewicz-Zygmund inequality Lemma~\ref{mzi}, therefore, 
\begin{multline*}
\bbe\abs{ \frac{1}{k}\sum_i f(x-a_i)-f\ast \mu_A(x)}^{2m} \leq \\(16m/k)^mk^{-1} \bbe \sum_i \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}.
\end{multline*}
We now sum both sides over all $x\in G$. By the triangle inequality, for any fixed $1\leq i\leq k$ and $a_i\in A$, 
\begin{align*}
\sum_{x\in G} \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}
&\leq 2^{2m-1}\sum_{x\in G}\abs{f(x-a_i)}^{2m}+\sum_{x\in G}\abs{f\ast \mu_A(x)}^{2m}\\
&\leq 2^{2m-1}\brac{\norm{f}_{2m}^{2m}+\norm{f\ast \mu_A}_{2m}^{2m}}.
\end{align*}
We note that $\norm{\mu_A}_1=\frac{1}{\abs{A}}\sum_{x\in A}\ind{A}(x)=\abs{A}/\abs{A}=1$, and hence by Young's inequality, $\norm{f\ast \mu_A}_{2m}\leq \norm{f}_{2m}$, and so 
\[\sum_{x\in G} \abs{f(x-a_i)-f\ast \mu_A(x)}^{2m}\leq 2^{2m}\norm{f}_{2m}^{2m}.\]
It follows that 
\[\bbe_{a_1,\ldots,a_k\in A}\norm{\frac{1}{k}\sum_i\tau_{a_i}f-f\ast \mu_A}_{2m}^{2m}\leq 
(64m/k)^m\norm{f}_{2m}^{2m}.\]
In particular, if $k\geq 256\epsilon^{-2}m$ then the right-hand side is at most $(\frac{\epsilon}{2}\norm{f}_{2m})^{2m}$ as required.
\end{proof}

\begin{lemma}\label{random_approx}
Let $\epsilon>0$ and $m\geq 1$. Let $A\subseteq G$ and $f:G\to \{0,1\}$. If $k\geq 256m\epsilon^{-2}$ then the set
\[\{ \tup{a}\in A^k : \norm{ \mu_\tup{a}*f - \mu_A*f }_{{2m}}\leq \epsilon\]
has size $\geq \abs{A}^k/2$.
\end{lemma}
\begin{proof}\uses{random_approx_expect}
Apply Lemma~\ref{random_approx_expect}. The lemma follows from this by averaging (also known as Markov's inequality): if $L$ is the set in question, then the contribution to this expectation from those $\tup{a}\not\in L$ is at least
\[\brac{1-\frac{\abs{L}}{\abs{A}^k}}(\epsilon \norm{f}_{2m})^{2m},\]
and hence comparing this to our upper bound we have
\[\brac{1-\frac{\abs{L}}{\abs{A}^k}}\leq 2^{-2m}\leq 1/2\]
as required.
\end{proof}

\begin{theorem}\label{ap}
Let $\epsilon>0$ and $m\geq 1$. Suppose that $A\subseteq G$ with density $\alpha$. Then, for any function $f:G\to\bbr$, there exists a set $T$ of size
\[\abs{T}\geq \alpha^{O(m\epsilon^{-2})}N\]
such that for all $t\in T$
\[\norm{\tau_t \mu_A\ast f-\mu_A\ast f}_{2m}\leq \epsilon \norm{f}_{2m}.\]
\end{theorem}
\begin{proof}\uses{random_approx}
Let $k=\lceil 1024m\epsilon^{-2}\rceil$. Let $L$ be the set from Lemma~\ref{random_approx} (with $\epsilon$ replaced by $\epsilon/2$), so that $\abs{L}\geq \tfrac{1}{2}\alpha^kN^k$. Let $\Delta=\{(s,\ldots,s) : s \in G\}$. We have
\[\abs{L}N= \sum_{z\in L+\Delta}\abs{\Delta\cap(L-z)}\]
so therefore since $\abs{L+\Delta}\leq N^k\leq 2\alpha^{-k}\abs{L}$ there exists some $z\in L$ such that
\[\abs{\Delta\cap(L-z)}\geq \frac{\alpha^k}{2}N.\]
Fix some $(t',\ldots,t')\in \Delta\cap L-z$, say $\vec{b}=(t',\ldots,t')+z\in L$. We claim that
\[T = \{ t\in S-S : (t+t',\ldots,t+t')\in \Delta\cap (L-z)\}\]
works. Indeed, we know that there exists some $\vec{a}\in L$ such that $\vec{a}=(t,\ldots,t)+(t',\ldots,t')+z=(t,\ldots,t)+\vec{b}$. Therefore
\begin{align*}
\norm{\tau_{t}(\mu_{\vec{b}}\ast f) - f\ast \mu_A}_{2m}
&=
\norm{\mu_{\vec{b}+(t,\ldots,t)}\ast f - f\ast \mu_A}_{2m}
\\
&\leq \tfrac{1}{2}\epsilon \norm{f}_{2m},
\end{align*}
and similarly
\begin{align*}
\norm{\tau_{t}(\mu_{\vec{b}}\ast f) - \tau_{t}(f\ast \mu_A)}_{2m}
&=
\norm{\mu_{\vec{b}}\ast f - f\ast \mu_A}_{2m}\\
&\leq \tfrac{1}{2}\epsilon \norm{f}_{2m}.
\end{align*}
It follows by the triangle inequality that
\[\norm{\tau_{t}(f\ast \mu_A) - f\ast \mu_A}_{2m}\leq \epsilon \norm{f}_{2m}\]
as required.
\end{proof}



\begin{theorem}\label{linfty_ap}
Let $\epsilon>0$ and $m\geq 1$, and $G$ be some finite abelian group of order $N$. Suppose that $A\subseteq G$ with density $\alpha=\abs{A}/N$. For any function $f:G\to\bbr$ there is a set $T$ such that
\[\abs{T}\geq \exp(-O(\log(1/\alpha)\log(1/\beta)\epsilon^{-2})N\]

and for all sets $B$ of density at least $\beta$ and for all $t\in T$
\[\norm{\tau_t \mu_A\ast \mu_B\ast f- \mu_A\ast \mu_B\ast f}_{\infty}\leq \epsilon \norm{f}_{2m}.\]
\end{theorem}
\begin{proof}\uses{ap}
Shifting $B$ if necessary, it suffices to prove 
\[\langle \ind{B}, \tau_t \ind{A}\ast f-\ind{A}\ast f\rangle \leq  \epsilon \abs{A}\abs{B}^{1/2m}.\]
Apply Holder's inequality with $m\approx \log(1/\beta)$, this bounds the left-hand side by 
\[\beta^{1-1/m}\norm{\tau_t\ind{A}\ast f-\ind{A}\ast f}_{2m}\leq 2\beta \norm{\tau_t\ind{A}\ast f-\ind{A}\ast f}_{2m},\]
say, and we are done by Theorem~\ref{ap}.
\end{proof}


\begin{theorem}\label{chang}
If 
\[\Delta = \{ \gamma : \lvert \widehat{\ind{X}(\gamma)}\rvert \geq \eta \mu(X)\}\]
then there is a set $\Gamma$ of size $O(\eta^{-2}\log(1/\mu(X)))$ such that
\[\Delta\subseteq \left\{\sum_{\gamma\in\Gamma}\epsilon_\gamma\gamma : \epsilon_\gamma\in \{-1,0,1\}\right\}.\]
\end{theorem}
\begin{proof}
Test.
\end{proof}

\begin{theorem}\label{ap_in_ff}
If $A_1,A_2,S\subseteq \bbf_q^n$ are such that $A_1$ and $A_2$ both have density at least $\alpha$ then there is a subspace $V$ of codimension
\[\mathrm{codim}(V)\ll_\epsilon \log(2/\alpha)^4\]
such that
\[\abs{\langle \mu_V\ast \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle-\langle \mu_{A_1}\ast \mu_{A_2},\ind{S}\rangle}\leq \epsilon.\]
\end{theorem}
\begin{proof}\uses{chang,linfty_ap}
Test.
\end{proof}